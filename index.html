<html>
<head>
  <script type="text/javascript" src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
</head>
<body>
  <cast-media-player id="player"></cast-media-player>
  <script>
  	const context = cast.framework.CastReceiverContext.getInstance();
  	const playerManager = context.getPlayerManager();
  	var urlHolder = "";

  	var cmp = document.getElementById("player");
  	var shadowVideo = cmp.shadowRoot.getElementById("castMediaElement");

  	function changeSource(url) {
  	  var firstSource = getFirstSource();

  	  firstSource.setAttribute('src', url);

  	  if (url.includes('.mp4')) {
  	    firstSource.setAttribute('type', 'video/mp4');
  	  } else {
  	    firstSource.setAttribute('type', 'application/x-mpegurl');
  	  }

  	}

  	function getFirstSource() {
  	   var firstSource = shadowVideo.getElementsByTagName("source")[0];

  	   if (!firstSource) {
  	   	 var source = document.createElement('source');
  	   	 shadowVideo.appendChild(source);
  	   	 firstSource = shadowVideo.getElementsByTagName("source")[0];
  	   }

  	   return firstSource;
  	}

  	function hideCMP() {
  		cmp.shadowRoot.querySelectorAll(".logo")[0].style.display = "none";
  		cmp.shadowRoot.querySelectorAll(".gradient")[0].style.display = "none";
  		cmp.shadowRoot.querySelectorAll(".audioPlaybackBackground")[0].style.display = "none";
  		cmp.shadowRoot.querySelectorAll(".audioPlaybackBackgroundScrim")[0].style.display = "none";

  	}

  	// playerManager.addEventListener(
  	//   cast.framework.events.EventType.MEDIA_STATUS, (event) => {

  	//     if (urlHolder != event.mediaStatus.media.contentUrl) {

  	//       urlHolder = event.mediaStatus.media.contentUrl;

  	//       changeSource(urlHolder);
  	//       shadowVideo.load();
  	//       shadowVideo.play();
  	//       hideCMP();

  	//     }
  	// }

  	playerManager.setMessageInterceptor(
  	  cast.framework.messages.MessageType.LOAD, loadRequestData => {
  	    
  	    var entity = loadRequestData.media.entity;
  	    var contentUrl = loadRequestData.media.contentUrl;

  	    changeSource(contentUrl);
  	    shadowVideo.load();
  	    shadowVideo.play();
  	    hideCMP();

  	    loadRequestData.media.entity = "";
  	    loadRequestData.media.contentId = "";
  	    loadRequestData.media.contentUrl = "";

        return loadRequestData;
  	});

	context.start();
  </script>
</body>
</html>
